name: E2E Verification

on:
  push:
    branches:
      - main
      - feature/*
  workflow_dispatch:

jobs:
  test-go-arm64:
    name: Go (CGO) arm64-linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Initialize Go Module
        run: |
          cd examples/go-cgo
          go mod init example/go-cgo
          go mod tidy

      - name: Create Dist Dir
        run: mkdir -p dist

      - name: Build Go (CGO)
        uses: ./ # Uses local action
        with:
          target: linux-arm64
          cmd: |
            cd examples/go-cgo
            go build -o ../../dist/app-go-arm64 .

      - name: Verify Go Binary
        run: file dist/app-go-arm64 | grep "ARM aarch64"

  test-rust-gnu:
    name: Rust aarch64-gnu
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Build Rust (Release)
        uses: ./
        with:
          target: aarch64-unknown-linux-gnu
          cmd: |
            cd examples/rust
            cargo build --release --target aarch64-unknown-linux-gnu

      - name: Verify Rust Binary
        run: file examples/rust/target/aarch64-unknown-linux-gnu/release/rust_cross | grep "ARM aarch64"

  test-c-windows:
    name: C windows-x64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Create Dist Dir
        run: mkdir -p dist

      - name: Build C (Direct CC)
        uses: ./
        with:
          target: windows-x64
          cmd: $CC examples/c/main.c -o dist/app.exe

      - name: Verify C Binary
        run: file dist/app.exe | grep "PE32+"
