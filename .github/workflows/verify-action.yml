name: Validation Suite

on:
  push:
    branches:
      - feature/verification
  workflow_dispatch:

jobs:
  validate-go:
    name: Go CGO (linux-arm64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Build
        uses: ./
        with:
          target: linux-arm64
          project-type: go
          cmd: |
            cd tests/go
            go build -o ../../dist/go-app .
      - name: Verify
        run: file dist/go-app | grep "ARM aarch64"

  validate-rust-gnu:
    name: Rust (linux-gnu) - Success Path
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu
      - name: Build
        uses: ./
        with:
          target: aarch64-unknown-linux-gnu
          project-type: rust
          # rust-musl-mode: deny (default) is fine here
          cmd: |
            cd tests/rust
            cargo build --release --target aarch64-unknown-linux-gnu
      - name: Verify Wrapper
        run: |
          # Verify that the wrapper script exists
          msg=$(ls -l /tmp/zig-wrappers/linker-wrapper* 2>/dev/null || echo "MISSING")
          if [[ "$msg" == "MISSING" ]]; then
            echo "Error: Linker wrapper not found in /tmp/zig-wrappers"
            exit 1
          fi
          echo "Found wrapper: $msg"

  validate-rust-musl-wiring:
    name: Rust (linux-musl) - Wiring Check Only
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run setup-env.sh for Rust Musl
        shell: bash
        env:
          INPUT_TARGET: aarch64-unknown-linux-musl
          INPUT_PROJECT_TYPE: rust
          INPUT_RUST_MUSL_MODE: allow
          # Setup basic outputs for the script to write to if needed,
          # though strictly setup-env writes to GITHUB_ENV which we can simulate or ignore for this logic check
          GITHUB_ENV: /dev/null
        run: |
          # We source the script to test the logic directly without the full action harness
          # validating that 'allow' sets the variables but doesn't crash.

          # Mock the export_var function since we don't have a real GITHUB_ENV file that persists easily here
          # or simply let it write to /dev/null and check the local var state if sourced.
          # Actually, source setup-env.sh usually exports vars to current shell too.

          source ./setup-env.sh

          echo "Checking CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER..."
          if [[ -z "$CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER" ]]; then
             echo "::error::Linker var not set!"
             exit 1
          fi
          echo "OK: Var is set to $CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER"

  validate-c:
    name: C (windows-x64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create Dist Dir
        run: mkdir -p dist
      - name: Build
        uses: ./
        with:
          target: windows-x64
          project-type: c
          cmd: $CC tests/c/main.c -o dist/c-app.exe
      - name: Verify
        run: file dist/c-app.exe | grep "PE32+"
