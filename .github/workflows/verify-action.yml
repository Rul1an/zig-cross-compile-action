name: Validation Suite

on:
  push:
    branches:
      - feature/verification
  workflow_dispatch:

jobs:
  validate-go:
    name: Go CGO (linux-arm64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
      - name: Build
        uses: ./
        with:
          target: linux-arm64
          project-type: go
          cmd: |
            cd tests/go
            go build -o ../../dist/go-app .
      - name: Verify
        run: file dist/go-app | grep "ARM aarch64"

  validate-rust-gnu:
    name: Rust (linux-gnu) - Success Path
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu
      - name: Build
        uses: ./
        with:
          target: aarch64-unknown-linux-gnu
          project-type: rust
          # rust-musl-mode: deny (default) is fine here
          cmd: |
            cd tests/rust
            cargo build --release --target aarch64-unknown-linux-gnu
      - name: Verify Wrapper
        shell: bash
        run: |
          echo "Checking check: CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=${CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER:-}"

          if [[ -z "${CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER:-}" ]]; then
            echo "Error: linker env var not set"
            exit 1
          fi

          WRAPPER="$CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER"
          if [[ ! -x "$WRAPPER" ]]; then
            echo "Error: linker wrapper not found or not executable: $WRAPPER"
            exit 1
          fi

          echo "OK: found wrapper at $WRAPPER"

  validate-rust-musl-wiring:
    name: Rust (linux-musl) - Wiring Check Only
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run setup-env.sh for Rust Musl
        shell: bash
        env:
          INPUT_TARGET: aarch64-unknown-linux-musl
          INPUT_PROJECT_TYPE: rust
          INPUT_RUST_MUSL_MODE: allow
        run: |
          # Source the script to test logic.
          # Now that export_var always exports, we don't need to unset GITHUB_ENV.

          source ./setup-env.sh

          echo "Checking CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER..."

          # Use defensive expansion because set -u is active in setup-env.sh (and might persist)
          if [[ -z "${CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER:-}" ]]; then
             echo "::error::Linker var not set!"
             exit 1
          fi

          echo "OK: Var is set to $CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER"

          if [[ ! -x "$CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER" ]]; then
            echo "::error::Wrapper path does not exist or is not executable"
            exit 1
          fi
          echo "OK: Wrapper exists."

  validate-c:
    name: C (windows-x64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Create Dist Dir
        run: mkdir -p dist
      - name: Build
        uses: ./
        with:
          target: windows-x64
          project-type: c
          cmd: $CC tests/c/main.c -o dist/c-app.exe
      - name: Verify
        run: file dist/c-app.exe | grep "PE32+"
